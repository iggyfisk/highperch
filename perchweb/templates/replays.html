{% import "races.html" as racemacros %}
{% import "tags.html" as tagmacros %}

{% macro card(replay, is_admin) %}
<div class="replay card">
    <div class="minimap">
        <a href="{{ url_for('views.view_replay', replay_id=replay['ID']) }}">
            <img src="{{replay['Map']|mapthumbnail}}" title="{{ replay['Map'] }}" />
            {% with drawmap = replay.get_drawmap() %}
            {% if drawmap['map_size'] %}
            <canvas
                class="drawmap"
                data-towers='{{ drawmap["towers_json"]|safe }}'
                data-mapsize='{{ drawmap["map_size"]|tojson|safe }}'
                data-startlocations='{{ drawmap["start_locations_json"]|safe }}'
                data-paintsize='2'></canvas>
            {% endif %}
            {% endwith %}
       </a>
    </div>
    <div class="details">
        <div class="header">
            <a class="title" href="{{ url_for('views.view_replay', replay_id=replay['ID']) }}">{{ replay['Name'] }}</a>
        </div>
        <p><a href="/replay/{{ replay['ID'] }}/download" title="Download replay"><i class="icon-download-alt"></i></a> | {{ replay['Length']|gametime }} | {{ replay['GameType'] }} | {{ replay['Map'] }} | {{ replay['TowerCount'] }} towers | {{ replay.upload_date() }} {% if replay['Official'] %}| {{ tagmacros.tag('Official') }}{% endif %}{% if is_admin %}| <span class="adminonly">{{ replay['UploaderIP'] }}  {{ replay['UploaderIP']|embed_country|safe }}{% endif %}</p>
        {{ teams(replay) }}
    </div>
</div>
{% endmacro %}

{% macro teams(replay, detailed=False) %}
    <div class="teams">
        {% for (teamId, players) in replay.teams().items() %}            
            <div class="team">
                {% if detailed %}
                <h2>
                    <span class="{% if winnerId is not none %}hp-expand{% endif %}">Team {{ teamId }}</span>
                    {% if teamId == replay['winningTeamId'] %}                    
                        <b class="result hp-hidden h">Winner{% if not replay['winningTeamConfirmed'] %}?{% else %}!{% endif %}</b>
                    {% elif winnerId is not none %}
                        <b class="result hp-hidden h">Loser{% if not replay['winningTeamConfirmed'] %}?{% else %}!{% endif %}</b>
                    {% endif %}
                </h2>
                {% endif %}
            {% for player in players %}
                <div class="player">
                    {% if detailed %}
                        <div class="icon-name">
                            {{ racemacros.icon(player['race'], player['raceDetected']) }}<a class="playername" style="color:{{ replay.player_colors[player['id']]|lighten }}" href="{{ url_for('views.view_player', battletag=player['name']) }}">{{ player['name']|displayname }}</a>
                            {% if replay.official() %}
                                {% if player.games_count() > 1 %}
                                    {% if not player.official() %}
                                        <span class="gamecount"><sup>({{ player.games_count() }})</sup></span>
                                    {% endif %}
                                {% endif %}
                            {% endif %}:
                            <div class="summary">
                                <span class="apmdata"><b>{{ player['apm'] }}</b>&nbsp;APM</span>
                                <span class="actiondata"><b>{{ player.action_count() }}</b>&nbsp;actions</span>
                                {% if player.tower_count() %}
                                | <span class="towerdata"><b>{{ player.tower_count() }}</b> towers</span>
                                <span class="tpmdata"><b>{{ player.towers_per_minute() }}</b>&nbsp;TPM</span>
                                {% endif %}
                                {% if player.net_feed()[0] + player.net_feed()[1] > 0 %}
                                | <b>{{ (player.net_feed()[0] + player.net_feed()[1])|thousands }}</b> sources fed
                                {% endif %}
                                {% if player['id'] == replay.mvp_id() %}
                                | <span class="award" title="MVP">üëë</span>
                                {% elif player['id'] == replay.grb_id() %}
                                | <span class="award" title="Garbage award">üóëÔ∏è</span>
                                {% endif %}
                            </div>
                        </div>
                            <div class="details">
                            {% for h in player.real_heroes() %}
                                <img class="hero" src="/static/images/game/heroes/{{ h['id'] }}.gif" title="{{ h['id']|heroname }}" /><b>{{ h['level'] }}</b>
                            {% endfor%}
                        </div>
                    {% else %}
                        <div class="icon-name">
                            {{ racemacros.icon(player['race'], player['raceDetected']) }}<a class="playername" href="{{ url_for('views.view_player', battletag=player['name']) }}">{{ player['name']|displayname }}</a> 
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
            </div>
        {% if not loop.last %}<div class="vs">vs</div>{% endif %}
        {% endfor %}
    </div>
{% endmacro %}